{% extends "base.html" %}

{% block title %}Payment - Raindrops Academy{% endblock %}

{% block content %}
<section class="payment-section">
    <div class="container">
        <div class="payment-container">
            <div class="payment-card">
                <div class="payment-header">
                    <h2>Complete Your Payment</h2>
                    <p>Secure your spot in {{ enrollment.course.name }}</p>
                </div>

                <div class="order-summary">
                    <h3>Order Summary</h3>
                    <div class="summary-item">
                        <span>Course:</span>
                        <strong>{{ enrollment.course.name }}</strong>
                    </div>
                    <div class="summary-item">
                        <span>Duration:</span>
                        <strong>{{ enrollment.course.duration }}</strong>
                    </div>
                    <div class="summary-item total">
                        <span>Amount Due:</span>
                        <strong class="price-large">${{ "%.2f"|format(enrollment.course.tuition_fee) }}</strong>
                    </div>
                </div>

                <form id="payment-form" class="payment-form">
                    <h3>Payment Details</h3>
                    
                    <div class="stripe-logo">
                        <svg height="26" viewBox="0 0 60 26" fill="#635BFF"><path d="M59.64 14.28h-8.06c.19 1.93 1.6 2.55 3.2 2.55 1.64 0 2.96-.37 4.05-.95v3.32a8.33 8.33 0 0 1-4.56 1.1c-4.01 0-6.83-2.5-6.83-7.48 0-4.19 2.39-7.52 6.3-7.52 3.92 0 5.96 3.28 5.96 7.5 0 .4-.04 1.26-.06 1.48zm-5.92-5.62c-1.03 0-2.17.73-2.17 2.58h4.25c0-1.85-1.07-2.58-2.08-2.58zM40.95 20.3c-1.44 0-2.32-.6-2.9-1.04l-.02 4.63-4.12.87V5.57h3.76l.08 1.02a4.7 4.7 0 0 1 3.23-1.29c2.9 0 5.62 2.6 5.62 7.4 0 5.23-2.7 7.6-5.65 7.6zM40 8.95c-.95 0-1.54.34-1.97.81l.02 6.12c.4.44.98.78 1.95.78 1.52 0 2.54-1.65 2.54-3.87 0-2.15-1.04-3.84-2.54-3.84zM28.24 5.57h4.13v14.44h-4.13V5.57zm0-4.7L32.37 0v3.36l-4.13.88V.88zm-4.32 9.35v9.79H19.8V5.57h3.7l.12 1.22c1-1.77 3.07-1.41 3.62-1.22v3.79c-.52-.17-2.29-.43-3.32.86zm-8.55 4.72c0 2.43 2.6 1.68 3.12 1.46v3.36c-.55.3-1.54.54-2.89.54a4.15 4.15 0 0 1-4.27-4.24l.01-13.17 4.02-.86v3.54h3.14V9.1h-3.13v5.85zm-4.91.7c0 2.97-2.31 4.66-5.73 4.66a11.2 11.2 0 0 1-4.46-.93v-3.93c1.38.75 3.1 1.31 4.46 1.31.92 0 1.53-.24 1.53-1C6.26 13.77 0 14.51 0 9.95 0 7.04 2.28 5.3 5.62 5.3c1.36 0 2.72.2 4.09.75v3.88a9.23 9.23 0 0 0-4.1-1.06c-.86 0-1.44.25-1.44.9 0 1.85 6.29.97 6.29 5.88z"/></svg>
                    </div>
                    
                    <div id="payment-element">
                        <!-- Stripe.js injects the Payment Element here -->
                    </div>

                    <div id="payment-message" class="payment-message"></div>

                    <button type="submit" id="submit-btn" class="btn btn-block btn-accent btn-large">
                        <span id="button-text">Pay ${{ "%.2f"|format(enrollment.course.tuition_fee) }}</span>
                        <div id="spinner" class="spinner" style="display: none;"></div>
                    </button>

                    <div class="payment-note">
                        <p>üîí Your payment information is secure and encrypted with Stripe.</p>
                        <p style="font-size: 0.85em; color: #6c757d; margin-top: 0.5rem;">
                            Powered by <strong>Stripe</strong> - Industry-leading payment security
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

{% if not stripe_configured %}
<script>
    // Demo mode - show simple form
    document.addEventListener('DOMContentLoaded', function() {
        const paymentElement = document.getElementById('payment-element');
        paymentElement.innerHTML = `
            <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 1.5rem; margin-bottom: 1.5rem;">
                <h4 style="color: #856404; margin-bottom: 0.5rem;">‚ö†Ô∏è Demo Mode</h4>
                <p style="color: #856404; margin: 0;">Stripe is not configured. This is a demo payment that will automatically succeed.</p>
                <p style="color: #856404; margin: 0.5rem 0 0; font-size: 0.9em;">
                    To enable real payments, add your Stripe API keys to the <code>.env</code> file. 
                    <a href="https://dashboard.stripe.com/test/apikeys" target="_blank" style="color: #856404; text-decoration: underline;">Get API keys</a>
                </p>
            </div>
            <div style="background: #f8f9fa; border-radius: 8px; padding: 2rem; text-align: center;">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="#2d8659" stroke-width="2" style="margin-bottom: 1rem;">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <h3 style="color: #2d8659; margin-bottom: 0.5rem;">Ready to Process Demo Payment</h3>
                <p style="color: #6c757d;">Click the button below to simulate a successful payment</p>
            </div>
        `;
        
        // Make form submit normally for demo
        const form = document.getElementById('payment-form');
        form.method = 'POST';
        form.action = '/payment/{{ enrollment.id }}';
    });
</script>
{% else %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe('{{ stripe_public_key }}');
    let elements;
    let paymentIntent;

    initialize();

    async function initialize() {
        try {
            const response = await fetch('/create-payment-intent/{{ enrollment.id }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Failed to initialize payment');
            }

            const { clientSecret, amount } = await response.json();

            const appearance = {
                theme: 'stripe',
                variables: {
                    colorPrimary: '#2d8659',
                    colorBackground: '#ffffff',
                    colorText: '#1e5a7d',
                    colorDanger: '#df1b41',
                    fontFamily: 'Poppins, system-ui, sans-serif',
                    borderRadius: '8px'
                }
            };

            elements = stripe.elements({ appearance, clientSecret });
            const paymentElement = elements.create('payment');
            paymentElement.mount('#payment-element');

        } catch (error) {
            showMessage(error.message);
        }
    }

    document.getElementById('payment-form').addEventListener('submit', handleSubmit);

    async function handleSubmit(e) {
        e.preventDefault();
        setLoading(true);

        try {
            const { error, paymentIntent } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: window.location.origin + '/dashboard',
                },
                redirect: 'if_required'
            });

            if (error) {
                showMessage(error.message);
                setLoading(false);
            } else if (paymentIntent && paymentIntent.status === 'succeeded') {
                // Send confirmation to backend
                const response = await fetch('/payment-success/{{ enrollment.id }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ payment_intent_id: paymentIntent.id })
                });

                if (response.ok) {
                    window.location.href = '/dashboard?payment=success';
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'Payment verification failed');
                    setLoading(false);
                }
            }
        } catch (err) {
            showMessage('An unexpected error occurred');
            setLoading(false);
        }
    }

    function showMessage(messageText) {
        const messageContainer = document.querySelector('#payment-message');
        messageContainer.textContent = messageText;
        messageContainer.style.display = 'block';
        
        setTimeout(() => {
            messageContainer.style.display = 'none';
        }, 5000);
    }

    function setLoading(isLoading) {
        const submitButton = document.querySelector('#submit-btn');
        const spinner = document.querySelector('#spinner');
        const buttonText = document.querySelector('#button-text');

        if (isLoading) {
            submitButton.disabled = true;
            spinner.style.display = 'inline-block';
            buttonText.style.display = 'none';
        } else {
            submitButton.disabled = false;
            spinner.style.display = 'none';
            buttonText.style.display = 'inline';
        }
    }
</script>
{% endif %}

<style>
    .stripe-logo {
        text-align: center;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    #payment-element {
        margin-bottom: 1.5rem;
    }

    .payment-message {
        color: #df1b41;
        font-size: 14px;
        line-height: 20px;
        padding: 12px;
        background: #fef2f2;
        border-radius: 6px;
        margin-bottom: 1rem;
        display: none;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #2d8659;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        vertical-align: middle;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    #submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
{% endblock %}
